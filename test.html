<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boss 测试页</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='10' fill='%2340a0ff'/%3E%3Ctext x='32' y='40' font-size='28' text-anchor='middle' fill='white'%3E%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .test-hint { position: fixed; left: 12px; bottom: 12px; background: rgba(0,0,0,0.55); color: #eaf6ff; padding: 10px 14px; border-radius: 8px; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', 'Noto Sans', 'Liberation Sans', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif; font-size: 14px; line-height: 1.5; box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
    .test-hint code { color:#aee9ff; }
  </style>
</head>
<body>
  <div id="hud">
    <div class="hud-left">
      <div class="panel xian-panel">
        <div class="panel-title">修仙面板</div>
        <div id="health-bar"><span id="health-fill"></span></div>
        <div id="stats">
          <span id="weapon-count">武器：0/5</span>
          <span id="highest-quality">最高品质：白色</span>
          <span id="kills-count">斩杀妖邪：0</span>
          <span id="treasure-held">所持法宝：无</span>
          <span id="pickup-log" class="log"></span>
        </div>
      </div>
    </div>
    <div class="hud-right">
      <div class="minimap-box">
        <canvas id="minimapCanvas" width="160" height="160"></canvas>
      </div>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <!-- 结算窗口（与 index.html 保持一致，供 game.js 使用） -->
  <div id="gameOverModal" class="modal hidden">
    <div class="modal-content">
      <h2>修行中道殒</h2>
      <p id="stat-pickups">获得法宝：0 件</p>
      <p id="stat-kills">斩杀妖邪：0 只</p>
      <p id="stat-time">存活时长：0 秒</p>
      <p id="stat-eval">评价：-</p>
      <button id="restart-btn">再入仙途</button>
    </div>
  </div>

  <div class="test-hint">
    <div>Boss 测试快捷键：</div>
    <div>1 = 战技（魔刀千刃 开/关），E = 战技（疯狂转刀）</div>
    <div>2 = 牛魔王（boss_niumo）</div>
    <div>3 = 佛陀（boss_fotuo）</div>
    <div>4 = 龙王（boss_longwang）</div>
    <div>5 = 女仙（boss_nvXian）</div>
    <div>6 = 天帝（boss_tiandi）</div>
    <div>0 = 清除当前所有 Boss</div>
    <div style="margin-top:6px">本页只生成玩家，不自动生成野怪与建筑；角色身边预置“各品质各一个”的武器掉落物，每个掉落物数量为 20。</div>
  </div>

  <noscript>需要启用JavaScript才能运行游戏。</noscript>
  <!-- 保持与 index.html 相同的加载顺序 -->
  <script src="src/assets.js"></script>
  <script src="src/core.js"></script>
  <script src="src/skill_system.js"></script>
  <script src="src/cultivation_panel.js"></script>
  <script src="src/help_panel.js"></script>
  <script src="src/treasure_fx.js"></script>
  <script src="src/treasures.js"></script>
  <script src="src/background.js"></script>
  <script src="src/enemies_buildings.js"></script>
  <script src="src/collisions.js"></script>
  <script src="src/monster_dialogue.js"></script>
  <script src="src/skill_vfx.js"></script>
  <script src="src/boss_skill_core.js"></script>
  <script src="src/boss_niumo_skills.js"></script>
  <script src="src/boss_buddha_skills.js"></script>
  <script src="src/boss_longwang_skills.js"></script>
  <script src="src/boss_fairy_skills.js"></script>
  <script src="src/boss_tiandi_skills.js"></script>
  <script src="src/render_particles.js"></script>
  <!-- 测试页专用：禁用自动刷怪/建筑，并在玩家附近生成 各品质各一个(每个数量20) 的掉落物 -->
  <script>
    (function(){
      const G = window.Game || (window.Game = {});
      // 禁用自动生成
      G.spawnEnemies = function(){};
      G.spawnBuildings = function(){};
      G.updateBuildingsCombat = function(){};
      // 清空集合，确保纯净环境
      G.enemies = Array.isArray(G.enemies) ? G.enemies : [];
      G.buildings = Array.isArray(G.buildings) ? G.buildings : [];
      G.enemies.length = 0;
      G.buildings.length = 0;
      // 彻底控制拾取刷新：清空随机生成，并覆盖更新逻辑（仅处理吸附动画，不再随机生成）
      G.pickups = Array.isArray(G.pickups) ? G.pickups : [];
      G.pickups.length = 0;
      const origUpdatePickups = G.updatePickups;
      G.updatePickups = function(dt){
        const picks = G.pickups || [];
        const player = G.player;
        if(!player) return;
        for(const p of picks){
          if(p.absorbing){
            const dx = player.x - p.x;
            const dy = player.y - p.y;
            const dist = Math.hypot(dx, dy) || 0.01;
            const pullSpeed = 800;
            p.x += (dx/dist) * pullSpeed * dt/1000;
            p.y += (dy/dist) * pullSpeed * dt/1000;
          }
        }
        // 不进行任何随机刷新的逻辑，避免越积越多导致卡顿
      };
  
      // 在玩家附近生成“各品质各一个”的拾取物，每个数量 20（一次性生成防重复）
      function spawnTestPickups(){
        const Gm = window.Game;
        if(!Gm || !Gm.player || !Array.isArray(Gm.pickups)) return;
        if(Gm._testPickupsSpawned) return; // 避免刷新后重复堆叠导致卡死
        Gm._testPickupsSpawned = true;
        const px = Gm.player.x, py = Gm.player.y;
        const qMax = Math.min((Gm.QUALITY||[]).length - 1, 7);
        const total = qMax + 1; // 各品质各一个
        const radius = 120;
        for(let i=0;i<total;i++){
          const ang = (i/total) * Math.PI * 2;
          const q = i; // 每个品质一个
          const obj = { x: px + Math.cos(ang)*radius, y: py + Math.sin(ang)*radius, r:18, q, count:20, skin:null };
          if(typeof Gm.placePickupNonOverlap === 'function') Gm.placePickupNonOverlap(obj);
          Gm.pickups.push(obj);
        }
      }
      // 等待当前事件循环结束，确保各模块初始化完成
      setTimeout(spawnTestPickups, 0);
    })();
  </script>
  <script src="src/game.js"></script>

  <script>
     (function(){
       function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
       function recalcWeaponAngles(e){
         const n = e.weapons.length;
         for(let i=0;i<n;i++){
           const w = e.weapons[i]; if(!w) continue;
           w.angle = (i / n) * Math.PI * 2;
           // Boss 的武器旋转半径更大
           w.radius = 22 + (w.quality||0) * 6;
         }
       }
       function createBossAt(skin, x, y){
         const G = window.Game; const world = G.world; const ssp = (G.SPIN_SPEED_TIERS && G.SPIN_SPEED_TIERS.mid) || 0.6;
         const boss = { x, y, vx:0, vy:0, speed:40, radius:24, health:500, maxHealth:500, weapons:[], maxWeapons:50, role:'boss', ai:'boss', skin, weaponSpin:0, weaponSpinSpeed: ssp, territory:{ cx:x, cy:y+260, r:260 }, formationSlot:{ x:x, y:y } };
         // 关键初始化，避免 updateEnemies 访问未定义字段导致异常
         boss.wanderTimer = 0;
         boss.wanderTarget = { x: boss.x, y: boss.y };
         boss.cultivation = (typeof G.getCultivationTypeBySkin==='function') ? G.getCultivationTypeBySkin(skin) : null;
         // 生成默认武器（高品质：4/5）
         const WEAPON_SKINS=['weapon_sword','weapon_staff'];
         const qualChoices=[4,5]; const count=20;
         boss.weapons.length = 0;
         for(let i=0;i<count;i++){
           const q = qualChoices[Math.floor(Math.random()*qualChoices.length)];
           const skinW = WEAPON_SKINS[Math.floor(Math.random()*WEAPON_SKINS.length)];
           boss.weapons.push({ id:Math.random().toString(36).slice(2), quality:q, angle:0, radius:10, damage:8+q*5, knockback: q>=2?70:35, alive:true, skin: skinW });
         }
         recalcWeaponAngles(boss);
         // 入列并保证坐标有效
         boss.x = clamp(boss.x, boss.radius, world.width - boss.radius);
         boss.y = clamp(boss.y, boss.radius, world.height - boss.radius);
         window.Game.enemies.push(boss);
         return boss;
       }
       function summonBossForKey(key){
         const G = window.Game; if(!G || !G.player) return;
         const px = G.player.x, py = G.player.y;
         const map = { '2':'boss_niumo', '3':'boss_fotuo', '4':'boss_longwang', '5':'boss_nvXian', '6':'boss_tiandi' };
         const skin = map[key]; if(!skin) return;
         // 保证同屏仅保留一个 Boss：清除其它皮肤的 Boss，若同款存在则迁移位置
         const bx = clamp(px + 160, 24, G.world.width - 24);
         const by = clamp(py - 160, 24, G.world.height - 24);
         const arr = (G.enemies||[]);
         let exists = null;
         for(let i=arr.length-1;i>=0;i--){ const e=arr[i]; if(!e) continue; if(e.role==='boss'){ if(e.skin===skin){ exists = e; } else { arr.splice(i,1); } } }
         if(exists){
           exists.x = bx; exists.y = by;
           exists.formationSlot = { x: bx, y: by };
           exists.territory = { cx: bx, cy: by+260, r: 260 };
           exists.wanderTimer = 0;
           exists.wanderTarget = { x: bx, y: by };
           return exists;
         }
         return createBossAt(skin, bx, by);
       }
       window.addEventListener('keydown', (ev)=>{
         const k = ev.key; if(ev.repeat) return;
         if(k in { '2':1, '3':1, '4':1, '5':1, '6':1 }){ summonBossForKey(k); }
         else if(k==='0'){
           // 清除所有 Boss
           const arr = window.Game.enemies;
           for(let i=arr.length-1;i>=0;i--){ const e=arr[i]; if(e && e.role==='boss'){ arr.splice(i,1); } }
         }
       });
     })();
   </script>
</body>
</html>